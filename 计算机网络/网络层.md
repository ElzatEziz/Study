# 网络层

网络层是OSI七层体系结构和五层体系结构中的第三层，TCP/IP协议中的第二层。



## 为什么需要网络层？

数据链路层解决了同一局域网计算机间帧的传输问题，没有解决以下问题：

- 异构网络互连，即跨局域网连接和资源共享
- 互联网络中主机标示的问题
- 互联网中主机间路由选择问题(最佳路径，路由选择算法)；
- 互联网中数据转发的问题(分组转发，互联网采用IP数据报)



> 局域网： 属于资源子网。
>
> 广域网：属于通信子网。



## 网络层的几个重要概念

### 1.网络层提供的两种服务

- 面向连接的可靠交付（网络层负责保证）
- 面向无连接的、尽最大努力交付的数据报服务，不提供服务质量的承诺。(端系统负责保证)。



#### （1）让网络负责可靠交付(OSI代表观点)

设计思路：

- 通信之前先建立虚电路(Virual Circuit)，以保证双方通信所需的一切网络资源。
- 如果再使用可靠传输的网络协议，就可以使所发送的分组无差错按序到达终点，不丢失、不重复。
- 较少了开销，因为建立了一个虚电路，不需要源和目的地址开销，需要一个虚电路号即可

> 虚电路服务：
>
> 虚电路只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送。并不是真正连接了一条物理连接。
>
> 存在的问题：
>
> 每两台之间进行通信都需要路由器维护一个虚电路，路由器的压力很大。如果一个路由器出现故障，则依靠这个路由器维护的虚电路全部不通，这时需要重新建立虚电路，要耗费一点时间。
>
> ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-11-30%2022.07.39.png)



#### （2）网络提供数据报服务(TCP/IP代表观点)

设计思路：

- 让网络层设计的尽量简单，向其上层只提供简单灵活的、无连接的、尽最大努力交付的数据报服务
- 网络在发送分组时候不需要先建立连接。
  - 每一个分组(即IP数据报)独立发送，与其前后的分组无关（不进行编号）
- 网络层不提供服务质量的承诺
  - 传送的分组可能出错、失序、丢失和重复，也不保证分组传送的时限
  - 有运输层负责可靠的通信。

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2000.28.22.png)



**虚电路服务于数据报服务的对比**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2000.27.29.png)



### 2.网络层的两个层面

- 数据层面
- 控制层面

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2000.31.07.png)



#### （1）数据层面

- 每个路由器独立工作，根据收到IP分组目的地址，按转发表转发至下一跳路由器（把收到的分组从查找到的对应接口转发出去）
- 独立工作
- 采用硬件进行转发，速度快（纳秒数量级，10^-9）



#### （2）控制层面

- 根据路由选择协议所用的路由算法计算路由，创建出本路由器的路由表（耗时长，秒级）
- 许多路由器协同动作，交换路由信息
- 采用软件计算，慢



**软件定义网络SDN（Software Defined Network）**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2000.39.17.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2000.39.34.png)



## 网际协议IP

网际协议IP是TCP/IP体系中两个最主要的协议之一。

与网际协议IPv4配套的3个协议：

- 地址解析协议ARP(Address Resolution Protocol)
- 网际控制报文协议ICMP(Internet Control Message Protocol)
- 网际组管理协议IGMP(Internet Group Management Protocol)



### 1.虚拟互联网络

前面我都探讨如何将两台计算机互连，那么如何将两个网络之间互相连接起来？

如何将网络互相连接起来？

-  都使用相同的网络？❌
  - 不能满足不同用户的需求。没有一种单一的网络能够适应所有用户的需求
- 使用中间设备✅
  - 可以满足不同需求



#### 1.使用中间设备互连

有以下五种不同的中间设备：

- 物理层中继系统：转发器(repeater中继器)、集线器(hub)
- 数据链路层中继系统：网桥或桥接器(bridge)、交换机(Switch)
- 网络层中继系统：路由器(router)
- 网桥和路由器的混合物：桥路器(brouter) 
- 网络层以上的中继系统：网关(gateway)



**网络互连使用路由器**

当中继系统是转发器或网桥时，一般并不称之为网络互连，仅仅是把一个网络扩大了，而这仍然是一个网络（局域网）

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2000.53.36.png)

网关由于比较复杂，目前使用的较少。

由于历史原因，许多TCP/IP的文献将网络层使用的路由器称之为网关。

> 网络互连(下图)都是指用路由器进行网络互连和路由选择

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2000.53.55.png)

#### 2.虚拟互联网络(IP网)的意义

所谓的虚拟互联网络也就是逻辑互联网络：

- IP协议可以使这些性能各异的网络从用户角度看起来好像是一个统一的网络(其实许多网络相互连接形成的一个大的网络)。
- 使用IP协议的虚拟互联网络可简称为IP网



使用虚拟互联网络的好处：

- 当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的具体的网络异构细节。

> 如果在这种覆盖全球IP网的上层使用TCP协议，那么就是现在的互联网(Internet)



![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2001.02.16.png)



### 2.分类的IP地址

在TCP/IP体系中，IP地址是一个最基本的概念，没有IP地址就无法和网上的其他设备进行通信。



**1.IP地址及其表示方法**

我们把整个因特网看成为一个单一的、抽象的网络：

- IP地址就是给每个连接在互联网上的主机（或路由器）分配一个在全世界范围是唯一的32位的标识符；
- IP地址由互联网名字和数字分配机构ICANN(Internet Corporation for Assigned Names and Numbers)进行分配

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2001.08.39.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2001.10.12.png)



**互联网上的每台主机（或路由器）的每个接口分配一个在全世界唯一的IP地址。由ICANN进行分配**![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2001.11.39.png)



**IP地址采用2级结构**

IP地址 == {<网络号>，<主机号>}

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2001.14.36.png)



**IP地址的编制方法**

- 分类的IP地址：
  - 最基本的编制方法，在1981年就通过了相应的标准协议
- 子网的划分：
  - 对最基本的编制方法的改进，其标准[RFC 950]在1985年通过
- 构成超网：
  - 比较新的无分类编制方法。1993年提出后很快就得到推广应用



(1)分类的IP地址

- 将IP地址划分为若干类固定类。
- 每一类地址都有固定长度字段组成，其中一个字段是网络号net-id，它标志主机（或路由器）所连接到的网络，而另一个字段主机号host-id，它标志着该主机（或路由器）
- 主机号在它前面的网络号所指明的网络范围内必须是唯一的。
- 由此可见，一个IP地址在整个互联网范围内是唯一的。

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2001.22.48.png)



**八位二进制与十进制间转换**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2001.24.14.png)



**一般不使用的特殊IP地址**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2001.25.04.png)



**分类IP地址的优点和缺点**

优点：

- 管理简单
- 使用方便
- 转发分组迅速
- 划分子网，灵活地使用

缺点：

- 设计上不合理
  - 大地址块，浪费地址资源
- 即使采用划分子网的方法，也无法解决IP地址枯竭的问题。



**IP地址的一些重要特点**

（1）IP地址是一种分等级的地质结构。分两个等级的好处是：

- 第一，IP地址管理机构在分配IP地址是时只分配网络号，而剩下的主机号则由该网络的单位自行匹配，这样就方便了IP地址的管理
- 第二，路由器仅根据主机所连接的网络号转发分组（而不考虑目的主机），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。



（2）实际上IP地址是标志一个主机（或路由器）和一条链路的接口

当一个主机同时连接到两个网络上时，该主机就必须同时具备两个相应的IP地址，其网络好net-id必须是不同的。这种追称为多归属主机

由于一个路由器至少应当连接到两个网络（这样它才能将IP数据报从一个网络转发到另一个网络），因此一个路由器至少应当有两个不同的IP地址。



（3）用转发器或网桥连接起来的若干个局域网仍是一个网络，因此这些局域网具有相同的网络号net-id



（4）所有分配到网络号net-id的网络，无论是范围很小的局域网，还是可能覆盖更大地理范围的局域网，都是平等的。



### 3.IP地址与MAC地址

IP地址

- 虚拟地址、软件地址、逻辑地址
- 网络层和以上各层使用
- 放在IP数据报的首部



MAC地址

- 固化在网卡上的ROM中
- 硬件地址、物理地址
- 数据链路层使用
- 放在MAC帧的首部



有硬件MAC地址，那为什么不直接用硬件地址直接通信？

> 硬件地址用于直接相连的网络(同一个二层广播网络)，用于找到局域网中的主机
>
> - 互联网中很多局域网是异构的，硬件地址不同，需要地址转换
> - IP地址是软件地址或逻辑地址，用于定位主机所处的网络(网络号不同的网络)，连接到互联网上的主机都有一个唯一的IP地址。
>
> 硬件地址与物理位置无关
>
> IP地址与“物理位置”相关



![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2018.12.18.png)



**IP地址和MAC地址的传输**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2018.14.04.png)



![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2018.14.32.png)

- 在IP层抽象的互联网上只能看到IP数据报；
- IP数据报首部有源站IP地址，但路由器指根据目的站的IP地址进行转发
- 在局域网的链路层，只能看见MAC帧
- 互连在一起的网络的MAC地址体系各不相同，但IP层抽象的互联网屏蔽了下层这些很复杂的细节；
- 网络层使用统一的抽象的IP地址研究主机和主机或路由器之间的通信。



### 4.地址解析协议ARP

已经知道了一个主机或路由器的IP地址，如何找出其相应的MAC地址？

地址解析协议ARP就是解决同一个局域网上的主机或路由器的IP地址和MAC地址映射问题

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2020.50.17.png)



**地址解析ARP的作用过程**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2020.51.36.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2020.52.38.png)



**要点1：ARP高速缓存**

存放最近获得的IP地址到MAC地址的绑定，以减少ARP广播的数量：

- 为了减少网络上的通信量，主机A在发送其ARP请求分组时，就将自己的IP地址到硬件地址的映射写入ARP请求分组；
- 当主机B收到A的ARP请求分组时，就将主机A的这一地址映射写入主机B自己的ARP高速缓存中，这对主机B以后向A发送数据报时就更方便了。

<img src="/Users/elzat/Library/Application Support/typora-user-images/截屏2022-12-02 20.58.20.png" alt="截屏2022-12-02 20.58.20" style="zoom:50%;" />



**要点2：ARP工作**

当主机欲向本局域网上的某个主机B发送IP数据报时：先其在ARP高速缓存中查看有无主机B的IP地址：

- 如果有，就可查出其对应的MAC硬件地址，再将此MAC地址写入MAC帧，然后通过局域网将该MAC帧发往此硬件地址；
- 如果没有，ARP进程在本局域网上广播发送一个ARP请求分组。收到ARP相应分组后，将得到的IP地址到硬件地址的映射写入ARP高速缓存。

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2021.00.04.png)



**要点3：ARP查找IP地址对应的MAC地址**

本局域网上广播发送ARP请求(路由器不转发ARP请求)。

ARP请求分组包含：

- 发送方硬件地址
- 发送方IP地址
- 目标方硬件地址（未知时填0）
- 目标方IP地址

单播ARP相应分组包含：

- 发送方硬件地址
- 发送方IP地址
- 目标方硬件地址
- 目标方IP地址

ARP分组封装在以太网帧中传输（数据链路层进行封装）



**ARP报文格式**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2022.47.35.png)



**注意问题**

ARP协议不能穿透路由器：

- ARP用于解决同一局域网上的主机或路由器的IP地址和硬件地址的映射问题；
- 如果所要找的主机和源主机不在同一个局域网上，那么就通过ARP找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络；
- 从IP地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的。



**使用ARP的四种典型情况**

1.主机与主机：直接交付，直连网络内。

2.主机与路由器：间接交付，交付给网关。

3.路由器与路由器：间接交付，路由器间转发。

4.路由器与主机：直接交付，路由器直接交付目标主机。



### 5.IP数据报的格式

IP数据报由首部和数据两部分组成。

首部的前一部分是固定长度，共20字节，是所有IP数据报必须具有的。

在首部的固定部分的后面是一些可选字段，其长度是可变的，共40字节。

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2023.08.45.png)

- 版本：占4位，指IP协议的版本，目前的IP协议版本号为4（即IPv4）
- 首部长度：占4位，可表示的最大数值是(60字节)15个单位（一个单位为4字节）。
- 区分服务：指明期望获得哪种类型服务，只有在使用区分服务时，这个字段才起作用，在一般情况下都不使用这个字段
- 总长度：占16位，首部+数据，单位为字节，数据报的最大长度为65535字节。
  - 注意总长度必须不超过最大传送单元MTU。(IP分片)
- 标识：是一个计数器，用来产生IP数据报标识。
- 标志：占3位，最高位无意义，目前只有前两位有意义，
  - 中间位DF
    - DF=1，不允许分片
    - DF=0，允许分片
  - 最低位MF
    - MF=1，后面还有分片
    - MF=0.这是最后一片
- 偏移量：占13位，某片在原始IP中的相对位置，以8字节位单位
- 生存时间：表示数据报在网络中的寿命，占 8 位。该字段由发出数据报的源主机设置。其目的是防止无法交付的数据报无限制地在网络中传输，从而消耗网络资源。
- 协议：表示该数据报文所携带的数据所使用的协议类型，占 8 位。该字段可以方便目的主机的 IP 层知道按照什么协议来处理数据部分。不同的协议有专门不同的协议号。
  - 例如，TCP 的协议号为 6，UDP 的协议号为 17，ICMP 的协议号为 1。
- 首部检验和：用于校验数据报的首部，占 16 位。数据报每经过一个路由器，首部的字段都可能发生变化（如TTL），所以需要重新校验。而数据部分不发生变化，所以不用重新生成校验值。
- 源地址：表示数据报的源 IP 地址，占 32 位。
- 目的地址：表示数据报的目的 IP 地址，占 32 位。该字段用于校验发送是否正确。
- 可选字段：该字段用于一些可选的报头设置，主要用于测试、调试和安全的目的。这些选项包括严格源路由（数据报必须经过指定的路由）、网际时间戳（经过每个路由器时的时间戳记录）和安全限制。
- 填充：由于可选字段中的长度不是固定的，使用若干个 0 填充该字段，可以保证整个报头的长度是 32 位的整数倍。
- 数据部分：表示传输层的数据，如保存 TCP、UDP、ICMP 或 IGMP 的数据。数据部分的长度不固定。



### 6.IP层转发分组的流程（基于终点转发）

基于终点转发：

- 路由器收到分组后，根据目的地址查询路由表，知道将分组转发至目的地，下一跳给那个路由器。

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2023.37.18.png)

**查找路由表**

根据目的网络地址就能确定下一跳路由器，这样做的结果是：

- IP数据报最终一定可以找到目的主机所在目的网络上的路由器(可能要通过多次的间接交付)
- 只有到达最后一个路由器时，才视图向目的主机进行直接交付。



**特定主机路由**

虽然互联网所有的分组转发都是基于目的主机所在的网络，但在大多数情况下都允许有这样的特例：

- 为特定的目的主机指明一个路由。
- 采用特定主机路由可使网络管理人员能更方便的控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。



**默认路由**

路由器还可采用默认路由以减少路由表所占用的空间和搜索路由表所用的时间。

> 这种转发方式在一个网络只有很少的对外连接时使很有用的。
>
> 默认路由在主机发送IP数据报时往往更能显示出它的好处。
>
> 网络之用一个路由器和互联网连接，这种情况下使用默认路由



**路由器分组转发算法**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2001.24.15.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-02%2023.48.56.png)





## 划分子网和构造超网

我们前面讨论过IP地址的编制方法

- 分类IP地址
- 划分子网的IP地址

前面已经讲了分类IP地址，下面我们探讨一下第二种划分子网的IP地址。

### 1.划分子网

#### 1.为什么划分子网？

早ARPANET早期，IP地址的设计确实不合理：

- IP地址空间的利用率有时很低
- 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变低
- 两级的IP地址不够灵活

为了解决这些不合理的两级IP地址，1985年起，IP地址中增加了“子网号字段”，使两级IP地址变成三级IP地址。这种做法叫做划分子网。

> 划分子网时把IP地址的主机好host-id进行再划分，而不改变IP地址的网络号net-Id



#### 2.划分子网的好处：

- 把大的广播域划分为较小的广播域；
- 提高IP地址空间的利用率；
- 保证网络的安全性；
- 提高网络的灵活性；



#### 3.划分子网的基本思路

从主机借用若干位作为子网号subnet-id，主机号host-id相应减少了若干位。

<img src="https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2000.01.09.png" />



一个未划分子网的B类网络145.13.0.0

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2000.17.39.png)



划分为三个子网后对外仍是一个网络

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2000.18.27.png)



划分子网可以更好的去管理网络，也可以减少路由器中路由表的记录，减少路由器的负担，但是上面只是我们自己在图上标记了子网，如果不标记的话，我们和计算机或路由器该如何知道呢？



**子网掩码**

在上图中我们划分了三个子网，那么路由器就必须知道子网划分情况，路由器会使用子网掩码计算IP地址的网络号

- 子网掩码长度 = 32位
- 子网掩码左边部分的一连串1 ： 对应位为网络号和子网号
- 子网掩码右边部分的一连串0 ：对应位为主机号



网络地址 = {<IP地址>,<子网掩码>}

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2000.29.04.png)



**默认子网掩码**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2001.09.31.png)



**子网掩码的一个重要属性**

子网掩码是一个网络或一个子网的重要属性：

- 路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器；
- 路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码；
- 若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码。
- ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2001.12.17.png)



### 2.使用子网时分组的转发

在不划分子网的两级IP下，从IP地址得出网络地址是个很简单的事。

但在划分子网的情况下，从IP地址却不能唯一地得出网络地址来，这是因为网络地址取决于那个网络所采用的子网掩码，但数据报的首部并没有提出子网掩码的信息。

所以，分组转发的算法也必须做相应的改动。

![截屏2022-12-03 01.23.41](/Users/elzat/Library/Application Support/typora-user-images/截屏2022-12-03 01.23.41.png)



### 3.无分类编制CIDR

**出现的问题：**

> 划分子网在一定程度上缓解了因特网在发展中遇到的困难，但是数量巨大的C类网因为其地址空间太小并没有得到充分使用，而因特网的IP地址仍在加速消耗，整个IPv4地址空间面领全部耗尽的威胁

**解决的方法：**

> 为此，因特网工程组IETF又提出了采用无分类编制的方法来解决IP地址紧张的问题，同时还专门成立IPv6工作组负责研究新版本IP以彻底解决IP地址耗尽问题

1993年，IETF发布了无分类域间路由选择CIDR（Classless Inter-Domain Routing）的RFC文档

- CIDR消除了传统的A类、B类和C类地址，以及划分子网的概念
- CIDR可以更加有效的分配IPv4的地址空间，并且可以在新的IPv6使用之前允许因特网的规模继续增长。



**无分类编制的记法**

CIDR使用“斜线记法”，或称CIDO记法，即在IPv4地址后加上一个斜线，然后写上网络前缀所占的比特数量或位数（这个数值对应于三级编制中子网掩码中1的个数）

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2001.41.44.png)



CIDR把网络前缀都相同的所有连续的IP地址组成一个CIDR地址块。

一个CIDR地址块包含的IP地址数目，取决于网络前缀的比特数或位数。



我们只要知道一个CIDR地址块中的任何一个地址，就可以知道该地址块的全部细节：

- 地址块的最小地址
- 地址块的最大地址
- 地址块的地址数量
- 地址块聚合某类网络（A类、B类或C类）的数量
- 地址掩码（也可继续成为子网掩码）



**路由聚合**

一个CIDR地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的一个项目可以表示很多个原来传统分类地址的路由：

- 路由聚合减少路由器之间的路由选择信息的交换，提高了整个互联网的性能；
- 路由聚合也称为构成超网（suppernetting）
- CIDR虽然不使用子网了，但仍然使用“掩码”这一名词（但不叫子网呀那么）；
- 对于/20地址块，它的掩码是20个连续的1。

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2001.58.23.png)



### 4.构造超网

前缀长度不超过23位的CIDR地址块都包含了多个C类地址，这些C类地址合起来就构成了超网：

- CIDR地址块中的地址数一定是2的整数次幂
- 网络前缀越短，其地址块所包含的地址数越多。
- CIDR的一个好处是
  - 可以更加有效的分配IPv4的地址空间，可根据客户的需要分配适当大小的CIDR地址块。
  - 因此在文献中有时成CIDR编制为“构造超网”



###  5.IP地址的特点

- 每个IP地址都有网络前缀和主机号两部分组成
- IP地址是标志一台主机（或路由器）和一条链路的接口
- 转发器或交换机连接起来的若干个局域网仍为一个网络
- 在IP地址中，所有分配到网络前缀的网络都是平等的



### 6.最长前缀匹配

使用CIDR时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能会得到不止一个匹配结果。

应当从匹配结果中选择具有最长网络前缀的路由：最长前缀匹配（longest-prefix matching）

网络前缀越长，其地址块就越小，因而路由就越具体。

例如：

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2002.08.45.png)



**转发表中的2种特殊的路由**

- 主机路由（host route）
  - 又叫特定主机路由
  - 是对特定目的主机的IP地址专门指明的一个路由
  - 网络前缀就是a.b.c.d/32
  - 放在转发表的最前面

> 采用特定主机路由可使网络管理人员能更方便的控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。

- 默认路由
  - 不管分组的最终目的网络在哪，都由指定的路由器R来处理用特殊前缀0.0.0.0/0表示

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2002.14.06.png)



**路由器分组转发算法**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2002.14.39.png)



### 7.使用二叉线索树查找转发表

二叉线索：一种特殊结构的树，可以快速在转发表中找到匹配的叶子节点。

从二叉线索树的根节点自顶向下的深度最多有32层，每一层对应于IP地址中的一位。

为简化二叉线索的结构，可以用唯一前缀来构造二叉线索。

为了提高二叉线索的查找速度，广泛使用了各种压缩技术

**用5个唯一前缀构成的二叉线索**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2002.17.13.png)

**在二叉线索树中查找IP地址**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2002.17.26.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2002.18.21.png)



## 网际控制报文协议ICMP

ICMP（Internet Control Massage Protocol）允许主机或路由器报告差错情况和提供有关异常情况的报告。

ICMP时互联网的标准协议，但不是高层协议，而是IP层的协议



### 1.为什么需要ICMP协议？

- 为了更有效的转发IP数据包和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP
- ICMP使主机或路由器报告差错情况和提供有关异常情况的报告（TTL=0）

ICMP分担IP的一部分功能

- 差错报告：目的不可达、源码抑制、超时、参数问题、重定向
- 查询：回送请求/应答、地址掩码请求/应答、时间戳请求/应答

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2019.14.07.png)





### 2.ICMP报文的格式

ICMP前4个字节都是一样的。

ICMP报文类型：

- 差错报告报文
- 询问应答报文

类型与代码的组合：

- 表示需要报告的详细信息

Checksum检验和：

对整个ICMP报文进行检验

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2019.16.02.png)



### 3.ICMP报文的种类

- 差错报告报文
- 询问报文

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2019.18.53.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2019.19.40.png)



**ICMP差错报告报文的数据字段的内容**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2019.31.11.png)



**不应发送ICMP差错报告报文的几种情况：**

- 对ICMP差错报告报文不再发送ICMP差错报告报文
- 对每一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
- 对具有多播地址的数据包不发送ICMP差错报告报文
- 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文



**ICMP询问报文**

- 回送请求和回答（请求：type=8，code=0；回答：type=0，code=0）
  - 由主机或路由器向一个特定的目的主机发出的询问
  - 收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文
  - 这种询问报文用来测试目的站是否可达，以及了解其有关状态。
- 时间戳请求和回答（请求：type=13，code=0；回答：type=14，code=0）
  - 请某台主机或路由器回答当前的日期和时间
  - 时间戳回答报文中有一个3位的字段，其中写入的整数代表从1900年1月1日起到当前时刻一共有多少秒
  - 时间戳请求与回答可用于时钟同步和时间测量



**ICMP的应用举例：**

PING（Packet InterNet Groper）

- 用来测试两个主机之间的连通性
- 使用了ICMP回送请求与回送回答报文
- 是应用层直接使用网络层ICMP的例子，没有通过运输层的TCP或UDP



Traceroute

- 这是UNIX操作系统中的名字。在Windows操作系统中这个命令时Tracert
- 用来跟踪一个分组从源点到终点的路径
- 它利用IP数据包中的TTL字段、ICMP时间超过差错报告报文 和 ICMP终点不可达差错报告报文 实现对从源点到终点的路径的跟踪



## 互联网的路由选择协议

### 1.有关路由选择协议的几个基本概念



路由选择协议属于网络控制层面的内容

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2019.45.52.png)



**理想的路由算法**

- 算法必须是正确的和完整的
- 算法在计算上应简单
- 算法应能适应通信量和网络拓扑的变化，要有自适应性
- 算法应具有稳定性
- 算法应是公平的
- 算法应是最佳的



> 关于最佳路由
>
> - 不存在一种绝对的最佳路由算法
> - 所谓“最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已
> - 实际的路由选择算法，应尽可能接近与理想的算法。
>
> 路由选择非常复杂的问题
>
> - 需要所有节点共同协调工作的
> - 环境不断变化，而这种变化有时无法事先知道
> - 当网络发声拥塞时，很难获取所需的路由选择信息



**路由选择算法分类（自适应）**

静态路由选择策略

- 非自适应路由选择；
- 不能及时适应网络状态的变化
- 简单、开销较小
- 管理开销比较大

动态路由选择策略

- 自适应路由选择
- 能较好的适应网络状态的变化
- 实现较为复杂，开销较大



**分层次的路由选择协议**

互联网为什么采用分层次的路由选择协议：

- 互联网的规模非常大。如果让所有的路由器知道所有的网络应怎样到达，则这种路由表将非常大，处理起来也太花时间。而所有这些路由器之间交换路由信息所需的带宽就会使互联网的通信链路饱和；
- 许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由选择协议（这属于本部门内部的事情），但同时还希望连接到互联网上。



怎么采用？

- 采用自适应的（即动态的）、分布式路由选择协议
- 把整个互联网划分为许多较小的自治系统AS，采用分层次的路由选择协议。

分为2个层次：

- 自治系统之间的路由选择 或 域间路由选择（interdomain routing）
- 自治系统内部的路由选择 或 域内路由选择（intradomain routing）

> 自治系统AS（Autonomous System）
>
> ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2020.03.17.png)



现在对自治系统AS的定义是强调下面的事实：

- 尽管一个AS使用了多种内部路由选择协议和度量，但重要的是一个AS对其他AS表现出一个单一的和一只的路由选择策略。一个规模较大的ISP就是一个AS
- 广义自治系统
  - 拥有AS号，例如一个规模较大的ISP
- 狭义自治系统
  - 未拥有AS号，例如，一个小规模的单位ISP



**2大路由选择协议**

内部网关协议IGP（Interior Gateway Protocol）

- 在一个自治系统内部使用的路由选择协议
- 常用：RIP，OSPF

外部网关协议EGP（External Gateway Protocol）

- 在不同自治系统之间进行路由选择时使用的协议
- 使用最多：BGP-4

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2020.12.38.png)



### 2.两大内部网关协议

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2020.13.47.png)

#### 1.RIP

**什么是RIP？**

路由信息协议RIP（Routing Information Protocol）是一种分布式的、基于距离向量的路由选择协议

运行RIP协议的路由器，维护从它自己到其他每一个目的网络的距离记录。

- 互联网的标准协议
- 最大优点：简单
- 要求网络中的每个路由器都要维护从它自己到其他每一个目的网络的距离纪录。



距离的定义

- 从一个路由器到直接连接的网络的距离定义 = 1（实际为0）
- 从一个路由器到非直接连接的网络的距离=未所经过的路由器数+1
- “距离”也称为“跳数“（hop count），因为每经过一个路由器，跳数就加1；
- 这里的”距离“实际上指的是”最短距离“

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2020.20.49.png)

> - 好路由 = “距离短” 的路由。最佳路由=“距离最短”的路由
> - 一条路径最多只包含15个路由器
> - “距离”的最大值为16时即相当于不可达，RIP只适用于“小型互联网”
> - RIP不能在两个网络之间同时使用多条路由，只选择“距离最短”的路由器哪怕还存在另一条高速（低时延）但路由器较多的路由。



**RIP协议的三个特点**

1. “ 和谁交换信息 ”：仅和相邻路由器交换信息
2. “ 交换什么信息 ”：交换的信息时当前本路由器所知道的全部信息，即自己的路由表
3. “ 什么时候交换 ”：按固定时间间隔交换路由信息，例如，每隔30秒。

> 当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息



**路由表的建立**

- 路由器在刚开始工作时，路由表时空的。
- 然后，得到直接连接的网络的距离（此距离定义为1）
- 之后，每个路由器也只和数目非常有限的相邻路由器交换并更新路由信息
- 进过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。
- RIP路由表项：目的网络、距离、下一跳
- RIP写的收敛过程较快。
  - 收敛就是在自治系统中所有的结点都得到正确的路由信息的过程



**路由表的主要信息和更新规则**

路由表主要信息：

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2022.37.38.png)

路由表更新规则：

使用距离向量算法找出到达每个目的网络的最短距离

> 距离向量算法：
>
> 对每个相邻路由器（假设其地址为X）发送过来的RIP报文，路由器：
>
> 1. 修改RIP报文中的所有项目（即理由）：把”下一跳“字段中的地址都改为X，并把所有的”距离“字段的值+1
> 2. 对修改后的RIP报文中的每一个项目，重复以下步骤
>    - 若路由表中没有目的网络N，则把该项目添加到路由表中，否则
>      - 若路由表中网络N的下一跳路由器为X，则用收到的项目替换原路由表中的项目。否则
>        - 若收到项目中的距离小于路由表中的距离，则用收到项目更新原路由表中的项目，否则
>          - 什么也不做
> 3. 若3分钟还未收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离设置为16（表示不可达）
> 4. 返回
>
> ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2022.43.14.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2022.45.58.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2022.46.11.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2022.46.37.png)



**RIP2报文**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2022.47.34.png)

- 组成：首部和路由2个部分
- 路由部分：
  - 地址族标识符（又称为地址类别）字段用来标识所使用的地址协议，IP协议该值为2
  - 路由标记填入自治系统的号码
  - 网络地址：路由条目的地址
  - 子网掩码：确定网络和子网部分的32掩码
  - 下一跳路由器地址：去往目的网络的下一跳路由
  - 距离：1～16之间的跳数，16为目的网络不可达

> 一个RIP报文最多可包括25个路由，因而RIP报文的最大长度是4+20x25=504字节。如超过，必须再用一个RIP报文来传送



**RIP协议特点**

好消息传播的快，坏消息传播的慢

问题：换消息传播的慢（慢收敛）

> 当网络出现故障时，要经过比较长的时间才能将此信息（坏消息）传送到所有路由器



**RIP协议优缺点**

优点：

- 实现简单
- 开销较小

缺点：

- 网络规模有限。最大距离为15
- 交换的路由信息为完整路由表，开销较大
- 坏消息传播的慢，收敛时间过长



####  2.OSPF

开放最短路径优先（Open Shortest Path First）是为客服RIP的缺点在1989年开发出来的。原理很简单，但实现很复杂

- “开放” 表明ISPF协议不是受某一家厂商控制，而是公开发表的
- ”最短路径优先“是因为使用了Dijkstra（狄克斯特拉）提出的最短路径算法SPF
- 采用分布式的链路状态协议（link state protocol）
- OSPF一个协议的名字，并表示其他的路由选择协议而不是“最短路径优先”
- 信息传递和路由计算分离
- 以 “累计链路开销”作为路由参考。现在使用OSPFv2



**三个主要特点**

- 和谁交换信息：采用洪泛法（flooding），向本自治系统中所有路由器发送信息
- 交换什么信息：发送的信息是与本路由器相邻的所有路由器的链路状态，但只是路由器所知道的部分信息
  - 链路状态：说明本路由器都和哪些路由器相邻，以及该链路的度量（metric，费用、距离、时延、带宽等）。
- 何时交换信息：当链路状态发生变化或每隔一段时间（如30分钟），路由器才用洪泛法香所有路由器发送此信息



**链路数据库**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.08.21.png)



**OSPF的区域**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.08.53.png)



**OSPF将自治系统划分为两种不同的区域**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.11.42.png)



**OSPF中的路由器：**

区域边界路由器ABR（area border router）

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.12.23.png)



主干路由器BR（backbone router）

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.13.16.png)



自治系统边界路由器ASBR（AS border router）

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.21.08.png)



**划分区域的优点和缺点**

优点：

- 减少了整个网络上的通信量
- 减少了需要维护的状态数量

缺点：

- 交换信息的种类增多了
- 使OSPF协议更加复杂了



**OSPF直接用IP数据包传送**

- OSPF不用UDP而是直接用IP数据报传送
- OSP构成的数据包很短。可减少路由信息的通信量
- 数据报短的另一好处是可以不必将唱的数据报分片传送
- 但分片传送的数据报只要丢失一个，就无法组装成原来的数据报，而整个数据报就必须重传



**OSPF特点**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.24.23.png)



**OSPF的报文格式**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.27.12.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.27.37.png)



**OSPF的五种分组类型**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.28.22.png)



**OSPF工作过程**

1. 确定邻站可达

   - 相邻路由器每隔10秒钟要交换一次问候分组
   - 若有40秒中没有收到某个相邻路由器发来的问候分组，贼认为该相邻路由器是不可达的

2. 同步链路状态数据库

   - 同步：指不同路由器的链路状态数据库的内容是一样的

   - 两个同步的路由器叫做完全邻接的路由器

   - > 不是完全邻接的路由器：它们虽然物理上是相邻的，但其链路状态数据库并没有达到一致

3. 更新链路状态

   - 只要链路状态发生变化，路由器就使用链路状态更新分组，采用可靠的洪泛法向全网更新链路状态。
   - 为确保链路状态数据库与全网的状态保持一致，OSP还规定：每隔一段时间，如30分钟，要刷新一次数据库中的链路状态

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.32.38.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.32.51.png)



**指定的路由器DR**

- 多点接入的局域网采用了指定的路由器DR（designated router）的方法，使广播的信息量大大减少
- 指定的路由器代表该局域网上所有的链路向连接到该网络上的各路由器发送状态信息。 

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.52.16.png)



### 3.外部网关协议BGP

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-03%2023.52.58.png)

**什么是BGP？**

BGP（Border Gateway Protocol）是一种增强的距离矢量路由协议，拥有丰富的策略控制技术（如何控制路由）

BGP是不同自治系统的路由器之间交换路由信息的协议

可以讲BGP-4缩写为BGP



**主要特点**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.02.07.png)



**BGP发言者（BGP speaker）**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.03.49.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.03.49.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.04.47.png)



**eBGP连接和iBGP连接**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.05.09.png)



**IGP，iBGP和eBGP的关系**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.06.07.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.07.10.png)



**BGP路由信息**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.07.40.png)



**三种不同的自治系统AS**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.18.32.png)



**BFP的路由选择方式**

1. 本地偏好（local preference）值最高的路由（默认值=100），只能在本AS传递
   - ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.21.42.png)
2. AS跳数最小的路由
   - ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.22.01.png)
3. 使用热土豆路由选择算法（分组在AS内的转发次数最少）
   - ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.22.24.png)
4. 路由器BGP ID数值最小的路由，具有多个接口的路由器有多个IP地址，BGP ID就使用该路由器的IP地址中数值最大的一个。



**BGP-4的四种报文**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.23.26.png)



**BGP报文具有通用首部**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.23.57.png)

标记：用于检查BGP对等的同步信息是否完整，以及yongyuBGP验证的计算（用于鉴别）

长度：整个BGP报文的长度，单位字节最小19，最大4096

类型：1～4，分别对应四种类型的BGP报文

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2000.24.12.png)



### 4.路由器的构成

路由器是网络层的设备，工作在网络层，用于互联网络，是互联网中的关键设备。

路由器的主要工作：转发分组。

> 把从某个输入端口收到的分组，按照分组要去的目的地（即目的网络），把该分组从路由器的某个合适的输出端口转发给下一跳路由器。



**路由器的结构**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2001.07.27.png)



**转发和路由选择的区别**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2001.07.47.png)



**输入端口对线路上收到的分组的处理**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2001.08.41.png)



**输出端口将交换结构传送来的分组发送到线路**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2001.10.23.png)



**交换结构**

常用交换方法有三种：通过存储器、通过总线、通过纵横交换结构

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2001.14.11.png)



通过存储器

- 当路由器的某个输入端口收到一个分组时，就用中断方式通知路由选择处理机，然后分组就从输入端口复制到存储器中
- 把路由器处理剂从分组首部提取目的地址，查找路由表，再将分组复制到合适的输出端口的缓存中。
- 若存储器的带宽（读或写）为每秒M个分组，那么路由器的交换速率（即分组从输入端口传送到输出端口的速率）一定小于M/2



通过总线

- 数据报从输入端口通过共享的总线直接传送到合适的输出端口，而不需要路由选择处理机的干预
- 当分组到达输入端口时若发现总线忙，则被阻塞而不能通过减缓结构，并在输入端口排队等待。
- 因为每一个要转发的分组都要通过这一条总线，因此路由器的转发带宽就收到总线速率的限制



通过纵横交换结构

- 常被称为互连网络
- 它有2N条总线，控制较差节点可以使N个输入端口和N个输出端口相连接。
- 当输入端口收到一个分组时，就将它发送到水平总线上
- 若通向输出端口的垂直总线空闲，则将垂直总线与水平总线接通，把该分组转发到这个输出端口，若输出端口已被占用，分组在输入端口排队等待。
- 特点：是一种无阻塞的交换结构，分组可以转发到任何一个输出端口，只要这个输出端口没有被别的分组占用。



**分组丢弃**

- 若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃
- 路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因。



## IPv6

随着时间的推移，IPv4出现了地址耗尽问题：

- 到2011年2月，IANA IPv4的32位地址已经耗尽
- 各地区互联网地址分配机构也相继宣布地址耗尽
- 我国在2014-2015年也逐步停止了向新用户和应用分配IPv4地址

如何解决这个地址耗尽问题？

- 采用具有更大地址空间的新版本的IP，即IPv6
- IPv6具有128位 2^128：3.4*10^38个地址左右



### 1.IPv6的基本首部

IPv6仍支持无连接的传送

将协议数据单元PDU称为分组

主要变化：

- 更大的地址空间。
  - 将地址从IPv4的32位增大到了128位
- 扩展的地址层次结构。
  - 可以划分为更多的层次。
- 灵活的首部格式
  - 定义了许多可选的扩展首部
- 改进的选项
  - 允许数据报包含有选项的控制信息，其选项放在有效载荷中
- 允许协议数据继续扩充
  - 更好地适应新的应用
- 支持即插即用（即自动配置）。
  - 不需要使用DHCP
- 支持资源的预分配
  - 支持实时视像等要求保证一定的带宽和时延的应用
- IPv6首部改为8字节对齐
  - 首部长度必须是8字节的整数倍



**IPv6数据报的一般格式**

有两大部分组成

- 基本首部
- 有效载荷
  - 有效载荷也称为净负荷。
  - 有效载荷允许有零个或多个扩展首部，在后面是数据部分。

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2021.29.59.png)



**IPv6数据报的基本首部**

- 首部长度：固定的40字节，称为基本首部
- 首部字段数：只有8个

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2021.32.51.png)



**帧格式**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2021.36.02.png)

- 版本（version）
  - 4位
  - 它指明了协议的的版本，对IPv6该字段总是6
- 通信量类
  - 8位
  - 这是为了区分不同的IPv6数据报的类别或优先级
  - 目前正在进行不同的通信量类性能的实验
- 流标号（flow lable）
  - 20位
  - “流”是互联网络上从特定源点到特定终点的一系列数据报，“流”所经过的路径上的路由器都保证指明的服务质量
  - 所有所有属于同一个流的数据报都具有同样的流标号
- 有效载荷长度（payload length）
  - 16位
  - 它指明IPv6数据报除基本首部以外的字节数（所有扩展首部都算在有效载荷之内），其最大值是64KB
- 下一个首部（next header）
  - 8位
  - 相当于IPv4的协议字段或可选字段
- 跳数限制（hop limit）
  - 8位
  - 源站在数据报发出时即设定跳数限制
  - 路由器在转发数据报时将跳数限制字段中的值减1
  - 当跳数限制的值为零时，就要将此数据报丢弃
- 源地址
  - 128位
  - 是数据报的发送站的IP地址
- 目的地址
  - 128位
  - 是数据报的接收站的IP地址

**IPv6的六种扩展首部**

- 逐跳选项
- 路由选择
- 分片
- 鉴别
- 封装安全有效载荷
- 目的站选项



### 2.IPv6的地址

三种基本类型：

- 单播（unicast）：传统的点对点通信
- 多播（multicast）：一点对多点的通信
- 任播（anycast）：IPv6增加的一种类型
  - 任播的终点是一组计算机，但数据报在交付时只交付其中的一个。
  - 通常是按照路由算法得出的距离最近的一个



**节点与接口**

- IPv6将实现IPv6的主机和路由器均称为节点
- 一个节点可能有多个与链路相连的接口
- IPv6地址是分配给节点上的接口的
  - 一个具有多个接口的节点可以有多个单播地址
  - 其中的任何一个地址都可以当作到达该节点的目的地址



**冒号十六进制记法**

- 在IPv6种，每个地址站128位，地址空间大于3.4*10^38次方
- 使用冒号十六进制记法（colon hexadecimal natation，简写为colon hex）：16位的值用十六进制表示，各值之间用冒号分割
- ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2022.35.02.png)

> 在十六进制表示使用两个技术：
>
> - 零压缩
>   - 一连串连续的零可以用一对冒号取代
>   - ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2022.36.55.png)
> - 点分十进制记法的后缀
>   - 结合点分十进制法的后缀在IPv4向IPv6的转换阶段特别有用
>   - ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2022.39.35.png)



**IPv6地址分类**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2022.40.01.png)



IPv6单播地址的划分方法

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2022.46.03.png)



### 3.以IPv4向IPv6过度

- 方法：
  - 逐步演进
  - 向后兼容
    - IPv6系统必须能够接受和转发IPv4分组，并且能够为IPv4分组选择路由
- 两种过渡策略
  - 使用双协议栈
  - 隧道技术



**双协议站**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2022.47.51.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2022.48.05.png)



**隧道技术**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2022.49.31.png)



**ICMPv6**

IPv6也需要使用ICMP来反馈一些差错信息，新的版本称为ICMPv6

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2022.53.09.png)



**ICMPv6报文的分类**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2022.53.42.png)



## IP多播（组播）

### 1.为什么需要IP多播

传统的点到点的应用：

- 服务提供以单个用户为单位提供服务
- 不同用户与服务提供端的通信数据存在差异

新型点到多点应用：

- 服务提供端以一组用户为单位提供服务
- 同组用户与服务提供端的通信数据无差异

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2022.56.51.png)



### 2.IP多播的基本概念

1988年，Stave Deering首次提出IP多播的概念

- 多播（multicast）：以前曾译为组播
- 目的：更好的支持一对多通信
  - 一对多通信：一个源点发送到许多个终点


![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2022.58.29.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-07%2001.01.16.png)



多播方式部署点到多点应用：

- 无重复流量
- 节省设备与带宽资源
- 安全性高
- 有偿性有保障

多播的问题（基于UDP）：

- 尽力而为
- 没有拥塞控制机制
- 报文重复
- 报文失序



**IP多播**

- 在互联网上进行多播就叫做IP多播
- 互联网范围的多播要靠路由器来实现。
- 能够运行多播协议的路由器称为多播路由器（multicast router）
- 多播路由器也可以转发普通的单播IP数据报
- 从1992年起，在互联网上开始试验虚拟的多播主干网MBONE（Multicast Backbone On the interNEt）



**多播IP地址**

- 一个多播IP地址并不是表示具体的某台主机，而是一组主机的集合；主机申明加入某多播组即标识自己需要接受目的地址为该多播地址的数据
- 在IP多播数据报的目的地址需要写入多播组的标识符
- 多播组的标识符就是IP地址中的D类地址（多播地址）
  - 地址范围：224.0.0.0 ～ 239.255.255.255
- 每一个D类地址标志一个多播组

> 多播地址只能用于目的地址，不能用于源地址



**多播类型分类**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2023.04.56.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2023.05.42.png)



众所周知的部分多播地址

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2023.06.31.png)



**多播地址分类**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-04%2023.07.27.png)



**多播MAC地址**

多播源如何封装多播数据？

目的IP如何确定？

目的MAC如何确定？

如何将组播IP地址映射到组播MAC地址？



**多播数据报**

- 多播数据报和一般的IP数据报的区别：

  - 目的地址：使用D类IP地址

  - 协议字段=2，表明使用网际组管理协议IGMP

- 尽最大努力交付，不保证一定能够交付多播组内的所有成员
- 对多播数据报不产生ICMP差错报文。在PING命令后面键入多播地址，将永远不后收到响应



### 3.在局域网上进行硬件多播

- IANA拥有的以太网地址块的高24位为00-00-5E
- TCP/IP协议使用的以太网地址块范围是
  - 从 00-00-5E-00-00-00
  - 到 00-00-5E-FF-FF-FF
  - IANA只拿出01-00-5E-00-00-00到01-00-5E-7F-FF-FF(2^23个地址)作为以太网多播地址。或者说，在48位的多播地址中，前25位固定不变，只有后23位可用作多播



**D类IP地址与以太网多播地址的映射关系**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2001.55.17.png)



### 4.网际组管理协议IGMP和多播路由选择协议

#### 1.IP多播需要两种协议

- 网际组管理协议IGMP（Internet Group Management Protocol）
  - 使用多播路由器知道多播组成员信息（有无成员）
- 多播路由选择协议
  - 使用多播路由器协同工作，把多播数据报用最小代价传送给多播组的所有成员

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2001.57.20.png)



**IGMP使多播路由器知道多播组成员信息**

IGMP协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机参与或退出了某个多播组。IGMP不知道IP多播组包含的成员数，也不知道这些成员都分布在哪些网络上。仅在本地网络范围内有效。

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2001.57.56.png)



**多播路由选择协议更为复杂**

连接在局域网上的多播路由器还必须和互联网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员。这就需要使用多播路由选择协议：

- 多播转发必须动态地适应多播组成员的变化（网络拓扑并未发生变化）
- 多播路由器在转发多播数据报时不能仅仅根据多播数据报中的目的地址，而是还要考虑这个多播数据报从什么地方来和要到什么地方去
- 多播数据报可由没有加入多播组的主机发出，也可以通过没有组成员接入的网络

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.01.35.png)



#### 2.网际组管理协议IGMP

发展史：

- 1989年公布的RFC 1112（IGMPv1）已成为互联网的标准协议
- 1997年公布的RFC 2236（IGMPv2，建议标准）对IGMPv1进行了更新
- 2002年10月公布了RFC 3376（IGMPv3，建议标准）



最后一跳路由器和用户之间使用的协议：在IP主机和与其直接相邻的多播路由器之间建立、维护多播关系；

多播路由器通过IGMP协议了解每个接口连接的网段上是否存在多播接受着    

- 有，组播路由器将数据报转发到这个网段，
- 没有，不转发

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.05.19.png)



**IGMP使用IP数据报传递其报文**

- 在IGMP报文加上IP首部构成IP数据报
- 但IGMP也向IP提供服务
- 因此，不把IGMP看成是一个单独的协议，而是整个网际协议IP的一个组成部分。



**IGMP工作可分为两个阶段**

- 第一阶段：加入多播组
  - ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.07.26.png)
- 第二阶段：探寻组成员变化情况
  - ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.07.39.png)



**IGMP采用一些具体措施，以避免增加大量开销**

- 所有通信都使用IP多播。只要有可能，都用硬件多播来传送
- 对所有的组只发送一个请求信息的询问报文。默认询问速率是每125秒发送一次
- 当同一个网络上连接有多个多播路由器时，能迅速和有效的选择其中的一个来探寻主机的成员关系
- 分散响应
  - 在IGMP的询问报文中以一个数值N，它指明一个最长响应时间（默认为10秒）。当收到询问时，之际在0到N之间随机选择发送响应所需经过的时延。若一台主机同时参加了几个多播组，则主机对每一个多播组选择不同的随机数。对应于最小时延的响应最先发送
- 采用抑制机制
  - 同一个组内的每一个主机都要监听响应，只要有本组的其他主机先发送了响应，自己就不再发送响应了。



#### 3.多播路由选择

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.12.47.png)



**几种多播路由选择协议**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.13.08.png)



**转发多播数据报时采用三种方法**

- 洪泛与剪除
- 隧道技术
- 基于核心的发现技术



1.洪泛与剪除

- 适合于较小的多播组，所有组成员接入的局域网也是相邻接的
- 开始时，路由器转发多播数据报使用洪泛的方法（这就是广播）
- 为避免兜圈子，采用反向路径广播RPB（Reverse Path Broadcasting）的策略

RPB的要点：

- 检查转发
  - <img src="https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.16.15.png" style="zoom:50%;" />
- 形成以源为根节点的多播转发数
  - <img src="https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.16.28.png" style="zoom:50%;" />
- 剪枝与嫁接
  - 剪枝：如果在多播转发树上的某个路由器发现它的下游树枝（即叶节点方向）已没有该多播组的成员，就把它和下游的树枝一起剪除
  - 嫁接：当某个树枝有树增加的组成员时，可以额再介入到多播转发数上
  - ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.19.52.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.20.10.png)



2.隧道技术

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.20.33.png)



基于核心的发现技术

-  对于多播组的大小在较大范围内变化时都适合
- 对每一个多播组G指定一个核心（core）路由器，并给出它的IP单播地址
- 核心路由器按照前面讲过的2种方法创建出对应于多播组G的转发数（核心路由器为根节点）

> ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.22.27.png)

- 如果有一个路由器R1向核心路由器发送数据报，那么它在途中经过的每一个路由器都要检查其内容
- 当数据报到达参加了多播组G的路由器R2时，R2就处理这个数据报
  - 如果R1发出的是一个多播数据报，其目的地址是G的组地址，R2就向G的成员转发这个多播数据报
  - 如果R1发出的数据报时一个请求加入多播组G的数据报，R2就把这个信息加到它的路由中，并用隧道技术向R1转发每一个多播数据报的副本



**RPF（Reverse Path Forwarding）检查**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2002.24.58.png)



## 虚拟专用网VPN

- 由于IP地址的紧缺，一个机构能够申请到的IP地址数往往远小于本机构所拥有的主机数
- 考虑到互联网并不很安全，一个机构内也并不需要把所有的主机介入到外部的互联网
- 如果一个机构内部的计算机通信也是采用TCP/IP协议，那么这些仅在机构内部使用的计算机就可以由本机构自行分配其IP地址



**本地地址与全球地址 **

- 本地地址：仅在机构内部使用IP地址，可以由本机构自行分配，而不需要向互联网的管理机构申请。
- 全球地址：全球唯一的IP地址，必须向互联网的管理机构申请。
- 问题：如何区分本地地址和全球地址
- 解决方法：RFC 1918指明了一些专用地址（private address）

> 专用地址只能用作本地地址，而不能用做全球地址
>
> 互联网中的所有路由器对目的地址是专用地址的数据报一律不进行转发。



**RFC 1918指明的专用IP地址**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2011.45.46.png)



**专用网**

- 采用专用IP地址的互联网称为专用互联网或本地互联网，或更简单些，就叫做专用网
- 专用IP地址也叫做可重用地址（reusable address）
- 那么专用网之间怎样通信呢？
  - 租用通信公司的通信线路
  - 理由现有的公共通信网络



**虚拟专用网VPN**

- 利用公用互联网作为本机构各专用网之间的通信载体，这样的专用网又称为虚拟专用网VPN（Virtual Private Network）
- 通信载体逻辑上的而不是物理上的



虚拟：

- 表示实际上没有使用通信专线，只是在效果上和真正的专用网一样

专用网：

- 指这种网络是为本机构的主机用于机构内部的通信，而不是用于网络外非本机构的主机通信



**核心技术：隧道技术和加解密技术**

隧道技术：

在隧道的两端通过分装以及解封装技术在供网上建立一条数据通信道；

使用这条数据通道对数据进行传输

隧道是由隧道协议构建形成的

隧道技术是VPN技术中的最关键的技术

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2011.50.31.png)



**VPN的典型应用场景**

公司-公司

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2011.52.26.png)



个人-公司

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2011.52.38.png)



隧道技术对比：

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2011.54.23.png)



![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2011.55.30.png)



**虚拟专用网VPN的构建**

- 如果专用网不同网点之间的通信必须经过公用的互联网，但又有保密的要求，那么所有通过互联网传输的数据都必须加密
- 必须为每一个场所苟免的专门的硬件和软件，并进行配置，使每一个场所的VPN系统都知道其他场所的地址



**VPN类型**

内联网（intranet）：同一个机构的内部网络所构成的VPN

外联网（extranet）：一个机构和某些外部机构共同建立的

远程接入VPN（remote access）：允许外部流动员工通过接入VPN建立VPN隧道访问公司内部网络，好像就是使用公司内部的本地网络访问一样。



## 网络地址转换NAT

问题：在专用网上使用专用地址的主机如何与互联网上的主机通讯（并不需要加密）？

解决：

- 在申请一些全球IP地址。但这在很多情况下是不容易做到的
- 采用网络地址转换NAT。这是目前使用的最多的办法



**网络地址转换NAT（Network Address Translation）**

- 1994年提出
- 需要在专用网连接到互联网的路由器上安装NAT软件
- 装有NAT软件的路由器叫做NAT路由器，它至少有一个有效的外部全球IP地址
- 所有使用本地地址的主机在和外界通信时，都要在NAT路由器上将其本地地址转换成全球IP地址，才能和互联网连接。



网络地址转换的过程：

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2012.05.54.png)

- 在内部主机与外部主机通信时，在NAT路由器上发生了两次地址转换：
  - 离开专用网时：替换源地址，将内部地址替换为全球地址
  - 进入专用网时，替换目的地址，将全球地址替换为内部地址

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2012.07.59.png)



**网络地址转换NAT**

- 当NAT路由器具有n个全球IP地址时，专用网内最多可以同时由n台主机接入到互联网
- 可以使专用网内较多的数量的主机轮流使用NAT路由器有限数量的全球IP地址

> 通过NAT路由器的通信必须由专用网内的主机发起，因此，专用网内部的主机不能充当服务器用



**网络地址与端口号转换NAPT**

- NAT并不能节省IP地址
- NAPT可以使多台拥有本地地址的主机，共用一个全球IP地址，同时和互联网上的不同主机进行通信。
- 使用运输层端口号的NAT叫做网络地址与端口号转换NAPT（Network Address and Port Translation），而不使用端口号的NAT就叫做传统的NAT（traditional NAT）



**NAPT地址转换表**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2012.35.51.png)

> - NAPT把专用网内不同的源IP地址都转换为相同的全球IP地址，将TCP源端口号转换为新的TCP端口号（互不相同）
> - 收到从互联网发来的应答时，从IP数据报的数据部分找出运输层端口号，从NAPT转换表中找到正确的目的主机



## 多协议标签交换MPLS

**三层转发和二层交换**

三层“转发”（forwarding）过程：

- 需要解封装，获取三层地址（软件实现，速度慢）
- 查找路由表，并获取下一跳硬件地址
- 封装成帧后发送至下一跳（硬件实现，速度快）
- 流量工程方面有缺陷

二层“交换”（switch）：

- 直接使用硬件转发（速度快）



**IP路由过程**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2012.43.12.png)



**MPLS：**

- MPLS就是在MPLS域的入口处，给每一个IP数据包打上固定长度”标签“，然后对打上标签的IP数据报用硬件地址进行转发，称为标签转换
  - ”交换“在转发时不再上升到第三层查找转发表，而是根据标签在第二层（链路层）用硬件进行转发
- MPLS可使用多种链路层协议（PPP、以太网、ATM、帧中继）



**MPLS特点**

- MPLS并没有取代IP，而是作为一种IP增强技术
- 特点：
  - 支持面向连接的服务质量
  - 支持流量工程，平衡网络负载
  - 有效的支持虚拟专用网VPN



### 1.MPLS的工作原理

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2012.47.07.png)



**MPLS的基本原理**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2012.48.04.png)



**MPLS域**

- MPLS域：指该域中有许多彼此相邻的路由器，并且所有的路由器都是支持MPLS技术的标记交换路由器LSR（Label Switching Router）
- LSR同时具有标记转换和路由选择这两种功能。标记交换功能是为了快速转发，路由选择功能是为了构造转发表



#### 1.MPLS基本工作过程

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2012.50.07.png)

1. 找出标签交换路径LSP
   - 各LSP使用标签分配协议LDP（Label Distribution Protocol）交换报文，找出和标签相对应的标签交换路径LSP（Label Switched Path）。整个标签交换路径就像一条虚连接一样
2. 打标签，然后转发
   - 入口节点（ingress node）给进入MPLS域的IP数据报打上标签（实际上是插入一个MPLS首部），并按照转发表把它准发给下一个LSR。以后所有的LSR都按照标签进行转发
   - 给IP数据报打标签的过程叫做分类
3. 标签对换
   - 一个标签仅在两个LSR之间才有意义
   - LSR要做两件事：转发、更新标记
   - 更新标记：把入标记更换称为出标记。称之为标签对换（label swapping）
   - ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2012.54.29.png)
4. 去除标签
   - 当分组离开MPLS域时，MPLS出口节点（egress node）把分组的标签去除
   - 把IP数据报交付给非MPLS的主机或路由器
   - ![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2012.55.35.png)



**MPLS的结构**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-06%2021.42.51.png)

#### 2.转发等价类FEC

- 给IP数据报打标签的过程叫做分类（classification）

  - 第三层（网络层）分类：只使用IP首部中的源和目的IP地址等

  - 大多数运营商实现了第四层（运输层）分类：除了要检查IP首部外，运输层还要检查TCP或UDP端口号

  - 有些运营商则实现了第五层（应用层）分类：进一步的检查数据报的内容并考虑有效载荷

- 转发等价类FEC（Forwarding Equivalence Class）：路由器按照同样方式对待的分组的集合

  - 按照同样方式对待含义：从同样接口转发到同样的下一跳地址，并且具有同样服务类别和同样丢弃优先级等

- 例如：

  - 目的IP地址与某一个IP数据报的前缀匹配的IP数据报
  - 所有源地址与目的地址都相同的IP数据报
  - 具有某种服务质量需求的IP数据报



![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.00.27.png)



**FEC用于负载平衡（流量控制）**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.00.57.png)



### 2. MPLS首部的位置与格式

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.01.54.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.02.09.png)



**MPLS首部的格式**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.02.23.png)



### 3.MPLS多层标签

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.03.01.png)



**MPLS：标签的操作类型**

- Push：
  - 当IP数据报进入MPLS域时，MPLS边界设备在二层首部和IP首部之间插入一个新标签；或者MPLS中间设备根据需要，在标签栈顶增加一个标签（标签嵌套）；
- Swap：
  - 报文在MPLS域内转发时，依据标签转发表，用下一跳分配的标签。替换MPLS报文的栈顶标签
- Pop：
  - 当报文离开MPLS域时，将MPLS报文的标签去掉



## 软件定义网络SDN简介

软件定义网络SDN（Software Defined Network）由斯坦福大学N.McKeown于2009年首先提出

谷歌于2010～2012年的数据中心网络B4进行了运行验证

优点：

- 提高网络带宽利用率
- 网络运行更加稳定
- 管理更加高效简化
- 运行费用明显降低



### 1.SDN与协议OpenFlow

SDN

- 是一个体系结构，是一种设计、构建和管理网络的新方法或新概念
- 把控制层面和数据层面分离，而让控制层面利用软件控制数据层面中的许多设备

OpenFlow

- SDN体系结构中控制层面和数据层面之间的通信接口
- 使控制层面的控制器可以对数据层面中的物理或虚拟设备进行直接访问和操纵
- 在逻辑上时集中式的、基于流的



**协议OpenFlow**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.26.06.png)



OpenFlow数据层面：

1.匹配+动作

- 数据层面的分组交换机或OpenFlow交换机完成 “匹配+动作”
- 称为广义转发

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.27.21.png)



2.流表

- 流表（flow table）：规定 “匹配+动作”
- 流：穿过网络的一种分组序列，而在此序列中的分组都共享分组首部某些字段的值

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.28.55.png)



**流表由远程控制器管理**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.29.28.png)



**流表结构**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.30.06.png)

1. 首部字段值：一组字段（12个），用来使入分组的对应首部与之相匹配。匹配不上的分组被丢弃，或发送到远程控制器做更多的处理
2. 计数器：一组计数器，可包括已经与该表项匹配的分组数量，以及从该表项上次更新到现在经历的时间
3. 动作：一组动作。当分组匹配某个流表项时，把分组转发到指明的端口，或丢弃该分组，或把分组进行复制后再从多个端口转发出去，或重写分组的首部字段（第二、三盒四层的首部字段）等



**例子：**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.33.11.png)



1. 简单转发

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.33.26.png)

2. 负载均衡

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.34.06.png)

3. 防火墙

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.34.41.png)



### 2.SDN体系结构

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.35.36.png)



**SDN体系结构的四个关键特征**

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.35.58.png)



**SDN与传统网络的差别**

SDN：

- 功能分散。
  - 交换机、SDN控制器、网络控制应用程序时可以分开的实体
- 可以由不同的厂商和机构来提供

传统网络：

- 控制层面、数据层面、协议的实现都垂直集成在一个机器里
- 由单独的厂商提供



### 3.SDN控制器

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.37.52.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.38.08.png)

![](https://gitee.com/zati/img-bed/raw/master/Img2/%E6%88%AA%E5%B1%8F2022-12-05%2013.38.30.png)
